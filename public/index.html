<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç‚¸é‡‘èŠ±</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
    }
    body {
      background: url("https://picsum.photos/id/119/1920/1080") no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      min-height: 100vh;
      overflow-x: hidden;
    }
    .page {
      display: none;
      width: 100%;
      height: 100vh;
      max-width: 1000px;
      margin: 0 auto;
      position: relative;
      padding: 20px;
    }
    .page.active {
      display: block;
    }

    /* é¦–é¡µæ ·å¼ */
    .home-box {
      background: rgba(0,0,0,0.6);
      border-radius: 20px;
      padding: 40px 30px;
      max-width: 420px;
      margin: 10vh auto 0;
      backdrop-filter: blur(10px);
    }
    .home-title {
      text-align: center;
      font-size: 36px;
      font-weight: bold;
      color: #ffd700;
      text-shadow: 0 4px 8px rgba(0,0,0,0.5);
      margin-bottom: 30px;
    }
    .input-item {
      margin-bottom: 20px;
    }
    .input-item label {
      display: block;
      font-size: 14px;
      color: #ddd;
      margin-bottom: 8px;
      padding-left: 10px;
    }
    .input-item input {
      width: 100%;
      padding: 14px 16px;
      border-radius: 12px;
      border: none;
      background: rgba(255,255,255,0.15);
      color: #fff;
      font-size: 16px;
    }
    .input-item input::placeholder {
      color: #aaa;
    }
    .home-btn-group {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 30px;
    }
    .btn {
      padding: 14px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-primary {
      background: linear-gradient(135deg, #ffb400, #ff8a00);
      color: #fff;
      box-shadow: 0 4px 12px rgba(255,138,0,0.4);
    }
    .btn-secondary {
      background: rgba(255,255,255,0.2);
      color: #fff;
    }
    .btn-small {
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 8px;
    }
    .btn-danger {
      background: #e53935;
      color: #fff;
    }
    .divider {
      text-align: center;
      color: #aaa;
      margin: 15px 0;
      font-size: 14px;
    }

    /* æˆ¿é—´å†…ç•Œé¢ï¼ˆæ–—åœ°ä¸»é£æ ¼ï¼‰ */
    .room-top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: absolute;
      top: 20px;
      left: 20px;
      right: 20px;
      z-index: 10;
      flex-wrap: wrap;
      gap: 10px;
    }
    .room-id-box {
      background: rgba(0,0,0,0.5);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      color: #ffd700;
      font-weight: bold;
    }
    .pot-box {
      background: rgba(0,0,0,0.5);
      padding: 8px 20px;
      border-radius: 20px;
      text-align: center;
    }
    .pot-title {
      font-size: 12px;
      color: #ddd;
    }
    .pot-num {
      font-size: 18px;
      color: #ffd700;
      font-weight: bold;
    }
    .back-btn {
      background: rgba(0,0,0,0.5);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-size: 18px;
      color: #fff;
      cursor: pointer;
    }

    /* æˆ¿ä¸»ä¸“å±ç­¹ç è®¾ç½®åŒºï¼ˆå³ä¸Šè§’è§’è½ï¼‰ */
    .owner-set-chip-box {
      background: rgba(0,0,0,0.7);
      padding: 10px 12px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      max-width: 380px;
    }
    .owner-set-chip-box select,
    .owner-set-chip-box input {
      padding: 6px 8px;
      border-radius: 8px;
      border: none;
      background: rgba(255,255,255,0.2);
      color: #fff;
      font-size: 13px;
    }
    .owner-set-chip-box select option {
      background: #222;
    }
    .owner-set-chip-box label {
      font-size: 13px;
      color: #ffd700;
      font-weight: bold;
    }

    /* ç©å®¶å¸ƒå±€ï¼ˆæ–—åœ°ä¸»é£æ ¼ï¼šä¸Š2ã€å·¦å³å„1ã€åº•1ï¼‰ */
    .players-area {
      width: 100%;
      height: 100%;
      position: relative;
    }
    .player-card {
      position: absolute;
      text-align: center;
      z-index: 5;
    }
    .player-card.top-left {
      top: 80px;
      left: 20px;
    }
    .player-card.top-right {
      top: 80px;
      right: 20px;
    }
    .player-card.left {
      top: 50%;
      left: 20px;
      transform: translateY(-50%);
    }
    .player-card.right {
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
    }
    .player-card.bottom {
      bottom: 140px;
      left: 50%;
      transform: translateX(-50%);
    }
    .player-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 3px solid #fff;
      overflow: hidden;
      margin: 0 auto 8px;
      background: #333;
    }
    .player-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .player-name {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 4px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    }
    .player-chip {
      font-size: 12px;
      color: #ffd700;
      margin-bottom: 4px;
    }
    .player-status {
      font-size: 12px;
      color: #0fec82;
      background: rgba(0,0,0,0.5);
      padding: 2px 8px;
      border-radius: 10px;
      display: inline-block;
    }

    /* ç‰Œé¢åŒºåŸŸ */
    .cards-area {
      position: absolute;
      bottom: 140px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 4;
    }
    .card {
      width: 80px;
      height: 112px;
      background: #fff;
      color: #000;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      display: grid;
      place-items: center;
      font-size: 26px;
      font-weight: bold;
      transition: all 0.3s ease;
    }
    .card.back {
      background: linear-gradient(135deg, #d32f2f, #b71c1c);
      color: #fff;
      font-size: 18px;
    }
    .card.red {
      color: #d32f2f;
    }
    .card.black {
      color: #000;
    }

    /* æ“ä½œæŒ‰é’®åŒºåŸŸï¼ˆæ–—åœ°ä¸»é£æ ¼ï¼‰ */
    .action-area {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 20px;
      align-items: center;
      z-index: 10;
    }
    .action-btn {
      width: 120px;
      height: 50px;
      border-radius: 25px;
      border: none;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    .action-btn.yellow {
      background: linear-gradient(135deg, #ffb400, #ff8a00);
      color: #fff;
      box-shadow: 0 4px 12px rgba(255,138,0,0.4);
    }
    .action-btn.blue {
      background: linear-gradient(135deg, #42a5f5, #1976d2);
      color: #fff;
      box-shadow: 0 4px 12px rgba(25,118,210,0.4);
    }
    .action-btn.green {
      background: linear-gradient(135deg, #66bb6a, #2e7d32);
      color: #fff;
      box-shadow: 0 4px 12px rgba(46,125,50,0.4);
    }
    .action-btn.red {
      background: linear-gradient(135deg, #ef5350, #c62828);
      color: #fff;
      box-shadow: 0 4px 12px rgba(198,40,40,0.4);
    }
    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .bet-input-box {
      background: rgba(0,0,0,0.6);
      padding: 8px 16px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .bet-input-box label {
      font-size: 14px;
      color: #fff;
    }
    .bet-input-box input {
      width: 80px;
      padding: 6px;
      border-radius: 10px;
      border: none;
      background: rgba(255,255,255,0.2);
      color: #fff;
      text-align: center;
      font-size: 16px;
    }

    /* å¼¹çª—æ ·å¼ */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: none;
      place-items: center;
      z-index: 999;
    }
    .modal.active {
      display: grid;
    }
    .modal-content {
      background: #fff;
      color: #333;
      border-radius: 20px;
      padding: 30px;
      max-width: 360px;
      width: 90%;
      text-align: center;
    }
    .modal-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 20px;
    }
    .modal-input {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-size: 16px;
      margin-bottom: 20px;
      text-align: center;
    }
    .modal-btn-group {
      display: flex;
      gap: 15px;
      justify-content: center;
    }
    .result-cards {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin: 20px 0;
    }
    .result-player-cards {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .result-card-row {
      display: flex;
      gap: 8px;
      justify-content: center;
    }
  </style>
</head>
<body>
  <!-- é¦–é¡µ -->
  <div class="page active" id="homePage">
    <div class="home-box">
      <h1 class="home-title">ç‚¸é‡‘èŠ±</h1>
      <div class="input-item">
        <label>ä½ çš„æ˜µç§°</label>
        <input type="text" id="nicknameInput" placeholder="è¯·è¾“å…¥ä½ çš„æ˜µç§°" autocomplete="off">
      </div>
      <div class="home-btn-group">
        <button class="btn btn-primary" id="createRoomBtn">åˆ›å»ºæˆ¿é—´</button>
        <div class="divider">æˆ–</div>
        <div class="input-item">
          <label>æˆ¿é—´å·</label>
          <input type="text" id="roomIdInput" placeholder="è¯·è¾“å…¥6ä½æ•°å­—æˆ¿é—´å·" maxlength="6" autocomplete="off">
        </div>
        <button class="btn btn-secondary" id="joinRoomBtn">åŠ å…¥æˆ¿é—´</button>
      </div>
    </div>
  </div>

  <!-- æ¸¸æˆæˆ¿é—´é¡µï¼ˆæ–—åœ°ä¸»é£æ ¼ï¼‰ -->
  <div class="page" id="gamePage">
    <div class="room-top-bar">
      <div class="back-btn" id="exitRoomBtn">â†</div>
      <div class="room-id-box" id="roomIdText">æˆ¿é—´å·ï¼š000000</div>
      <div class="pot-box">
        <div class="pot-title">å¥–æ± </div>
        <div class="pot-num" id="potNum">0</div>
      </div>

      <!-- æˆ¿ä¸»ä¸“å±ç­¹ç è®¾ç½®åŒºï¼ˆå³ä¸Šè§’è§’è½ï¼‰ -->
      <div class="owner-set-chip-box" id="ownerSetBox" style="display: none;">
        <label>è®¾ç½®ç­¹ç </label>
        <select id="playerSelect"></select>
        <input type="number" id="setChipInput" placeholder="ç­¹ç æ•°" min="0" value="1000">
        <button class="btn btn-small btn-primary" id="confirmSetChipBtn">ç¡®å®š</button>
      </div>
    </div>

    <div class="players-area" id="playersArea"></div>
    <div class="cards-area" id="myCardsArea"></div>

    <div class="action-area" id="actionArea">
      <div class="bet-input-box" id="betInputBox">
        <label>ä¸‹æ³¨ï¼š</label>
        <input type="number" id="betInput" value="1" min="1">
      </div>
      <button class="action-btn blue" id="lookBtn" disabled>çœ‹ç‰Œ</button>
      <button class="action-btn yellow" id="callBtn" disabled>è·Ÿæ³¨</button>
      <button class="action-btn yellow" id="raiseBtn" disabled>åŠ æ³¨</button>
      <button class="action-btn green" id="compareBtn" disabled>æ¯”ç‰Œ</button>
      <button class="action-btn red" id="foldBtn" disabled>å¼ƒç‰Œ</button>
      <button class="action-btn yellow" id="readyBtn" style="display: none;">å‡†å¤‡</button>
      <button class="action-btn green" id="startBtn" style="display: none;" disabled>å¼€å§‹æ¸¸æˆ</button>
    </div>
  </div>

  <!-- ç»“æœå¼¹çª— -->
  <div class="modal" id="resultModal">
    <div class="modal-content">
      <div class="modal-title" id="resultTitle">æ¸¸æˆç»“æŸ</div>
      <div class="result-cards" id="resultCards"></div>
      <div class="modal-title" id="resultDesc">ä½ èµ¢äº†ï¼</div>
      <button class="btn btn-primary" id="closeResultBtn">ç¡®è®¤</button>
    </div>
  </div>

  <script>
    // æ ¸å¿ƒé…ç½®
    const BASE_BET = 1;
    const MAX_PLAYERS = 5;
    const MIN_PLAYERS = 2;
    const CARD_SUITS = ['â™ ', 'â™¥', 'â™£', 'â™¦'];
    const CARD_RANKS = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
    const HAND_TYPE = {
      HIGH_CARD: 0,
      PAIR: 1,
      STRAIGHT: 2,
      FLUSH: 3,
      STRAIGHT_FLUSH: 4,
      THREE_OF_A_KIND: 5,
      SPECIAL_235: 6
    };
    const HAND_TYPE_NAME = {
      0: 'å•å¼ ',
      1: 'å¯¹å­',
      2: 'é¡ºå­',
      3: 'é‡‘èŠ±',
      4: 'é¡ºé‡‘',
      5: 'è±¹å­',
      6: 'ç‰¹æ®Š235'
    };
    const AVATAR_LIST = [
      'https://picsum.photos/id/64/200/200',
      'https://picsum.photos/id/65/200/200',
      'https://picsum.photos/id/91/200/200',
      'https://picsum.photos/id/94/200/200',
      'https://picsum.photos/id/129/200/200'
    ];

    // å…¨å±€çŠ¶æ€
    let currentPage = 'homePage';
    let myId = Math.random().toString(36).substring(2, 10);
    let myNickname = '';
    let currentRoomId = '';
    let roomData = {};
    let syncTimer = null;

    // DOMå·¥å…·
    const $ = (id) => document.getElementById(id);
    const showPage = (pageId) => {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      $(pageId).classList.add('active');
      currentPage = pageId;
    };

    // æˆ¿é—´å­˜å‚¨
    const RoomStore = {
      get: (roomId) => {
        const data = localStorage.getItem(`zhajinhua_room_${roomId}`);
        return data ? JSON.parse(data) : null;
      },
      set: (roomId, data) => {
        localStorage.setItem(`zhajinhua_room_${roomId}`, JSON.stringify(data));
      },
      delete: (roomId) => {
        localStorage.removeItem(`zhajinhua_room_${roomId}`);
      }
    };

    // ç”Ÿæˆæˆ¿é—´å·
    const generateRoomId = () => Math.floor(100000 + Math.random() * 900000).toString();

    // ç‰Œå‹åˆ¤æ–­
    function evaluateHand(cards) {
      const values = cards.map(c => c.value).sort((a, b) => b - a);
      const isFlush = cards.every(c => c.suit === cards[0].suit);
      const isStraight = (values[0] - values[2] === 2 && new Set(values).size === 3) || (values.join(',') === '14,3,2');
      const isThreeOfAKind = values[0] === values[1] && values[1] === values[2];
      const isPair = new Set(values).size === 2;
      const is235 = values.join(',') === '5,3,2';

      if (is235) return { type: HAND_TYPE.SPECIAL_235, value: 999, values };
      if (isThreeOfAKind) return { type: HAND_TYPE.THREE_OF_A_KIND, value: values[0], values };
      if (isStraight && isFlush) return { type: HAND_TYPE.STRAIGHT_FLUSH, value: values[0], values };
      if (isFlush) return { type: HAND_TYPE.FLUSH, value: values, values };
      if (isStraight) return { type: HAND_TYPE.STRAIGHT, value: values[0], values };
      if (isPair) {
        const pairValue = values.find((v, i, arr) => arr.indexOf(v) !== i);
        const kicker = values.find(v => v !== pairValue);
        return { type: HAND_TYPE.PAIR, value: pairValue, kicker, values };
      }
      return { type: HAND_TYPE.HIGH_CARD, value: values, values };
    }

    // æ¯”ç‰Œé€»è¾‘
    function compareHands(hand1, hand2, isHand1Initiator) {
      if (hand1.type !== hand2.type) return hand1.type > hand2.type ? 'hand1' : 'hand2';
      if (hand1.value > hand2.value) return 'hand1';
      if (hand1.value < hand2.value) return 'hand2';
      return isHand1Initiator ? 'hand2' : 'hand1';
    }

    // æ´—ç‰Œ
    function createDeck() {
      const deck = [];
      CARD_SUITS.forEach(suit => {
        CARD_RANKS.forEach((rank, index) => {
          deck.push({ suit, rank, value: index + 2, color: suit === 'â™¥' || suit === 'â™¦' ? 'red' : 'black' });
        });
      });
      return deck.sort(() => Math.random() - 0.5);
    }

    // åŒæ­¥é€»è¾‘
    function startSync() {
      stopSync();
      syncTimer = setInterval(() => {
        const latestRoom = RoomStore.get(currentRoomId);
        if (!latestRoom) {
          alert('æˆ¿é—´å·²è§£æ•£');
          exitRoom();
          return;
        }
        roomData = latestRoom;
        renderGamePage();
      }, 800);
    }
    function stopSync() {
      if (syncTimer) clearInterval(syncTimer);
    }
    function updateRoomData(updateFunc) {
      const latestRoom = RoomStore.get(currentRoomId);
      if (!latestRoom) return;
      updateFunc(latestRoom);
      RoomStore.set(currentRoomId, latestRoom);
      roomData = latestRoom;
    }

    // ç©å®¶ä½ç½®æ˜ å°„
    const PLAYER_POSITION = ['top-left', 'top-right', 'left', 'right', 'bottom'];

    // æ¸²æŸ“ç©å®¶é€‰æ‹©ä¸‹æ‹‰æ¡†
    function renderPlayerSelect() {
      const select = $('playerSelect');
      if (!roomData || !roomData.players) {
        select.innerHTML = '';
        return;
      }
      // æ¸²æŸ“æ‰€æœ‰ç©å®¶
      select.innerHTML = roomData.players.map(player => 
        `<option value="${player.id}">${player.nickname}${player.isOwner ? 'ï¼ˆæˆ¿ä¸»ï¼‰' : ''}</option>`
      ).join('');
    }

    // æ¸²æŸ“æ¸¸æˆé¡µ
    function renderGamePage() {
      if (!roomData) return;
      const myData = roomData.players.find(p => p.id === myId);
      if (!myData) return;
      const isOwner = myData.isOwner;
      const isGamePlaying = roomData.gameStatus === 'playing';

      // é¡¶éƒ¨ä¿¡æ¯
      $('roomIdText').innerText = `æˆ¿é—´å·ï¼š${currentRoomId}`;
      $('potNum').innerText = roomData.pot;

      // æˆ¿ä¸»è®¾ç½®åŒºæ˜¾ç¤ºæ§åˆ¶ï¼šåªæœ‰æˆ¿ä¸»ã€æ¸¸æˆæœªå¼€å§‹æ—¶æ˜¾ç¤º
      $('ownerSetBox').style.display = (isOwner && !isGamePlaying) ? 'flex' : 'none';
      // åˆ·æ–°ç©å®¶é€‰æ‹©ä¸‹æ‹‰æ¡†
      renderPlayerSelect();

      // æ¸²æŸ“ç©å®¶
      const playersArea = $('playersArea');
      playersArea.innerHTML = '';
      
      // æ’åºç©å®¶ï¼Œè‡ªå·±å›ºå®šåœ¨åº•éƒ¨
      const otherPlayers = roomData.players.filter(p => p.id !== myId);
      const sortedPlayers = [...otherPlayers, myData];
      
      sortedPlayers.forEach((player, index) => {
        const isMe = player.id === myId;
        const position = isMe ? 'bottom' : PLAYER_POSITION[index];
        const playerHtml = `
          <div class="player-card ${position}">
            <div class="player-avatar">
              <img src="${AVATAR_LIST[index % AVATAR_LIST.length]}" alt="å¤´åƒ">
            </div>
            <div class="player-name">${player.nickname} ${player.isOwner ? 'ğŸ‘‘' : ''}</div>
            <div class="player-chip">ç­¹ç ï¼š${player.chips}</div>
            <div class="player-status">${player.folded ? 'å·²å¼ƒç‰Œ' : player.looked ? 'å·²çœ‹ç‰Œ' : isGamePlaying ? 'æ¸¸æˆä¸­' : player.ready ? 'å·²å‡†å¤‡' : 'æœªå‡†å¤‡'}</div>
          </div>
        `;
        playersArea.innerHTML += playerHtml;
      });

      // æ¸²æŸ“æˆ‘çš„ç‰Œ
      const cardsArea = $('myCardsArea');
      if (myData.cards.length === 0) {
        cardsArea.innerHTML = '<div class="card back">?</div><div class="card back">?</div><div class="card back">?</div>';
      } else {
        if (myData.looked) {
          cardsArea.innerHTML = myData.cards.map(c => `<div class="card ${c.color}">${c.rank}${c.suit}</div>`).join('');
        } else {
          cardsArea.innerHTML = '<div class="card back">?</div><div class="card back">?</div><div class="card back">?</div>';
        }
      }

      // æŒ‰é’®æ˜¾ç¤ºæ§åˆ¶
      const isMyTurn = roomData.currentTurn === myId && !myData.folded && isGamePlaying;
      const betDiff = roomData.currentMaxBet - myData.bet;
      const callAmount = myData.looked ? betDiff * 2 : betDiff;
      const canCall = betDiff > 0 && myData.chips >= callAmount;
      const canRaise = myData.chips > callAmount;
      const canCompare = betDiff === 0 && roomData.players.filter(p => !p.folded).length >= 2;

      // ç­‰å¾…é˜¶æ®µæŒ‰é’®
      if (!isGamePlaying) {
        $('betInputBox').style.display = 'none';
        $('lookBtn').style.display = 'none';
        $('callBtn').style.display = 'none';
        $('raiseBtn').style.display = 'none';
        $('compareBtn').style.display = 'none';
        $('foldBtn').style.display = 'none';
        $('readyBtn').style.display = 'block';
        $('startBtn').style.display = 'block';

        $('readyBtn').disabled = myData.ready;
        $('readyBtn').innerText = myData.ready ? 'å·²å‡†å¤‡' : 'å‡†å¤‡';
        $('startBtn').disabled = !isOwner || !roomData.players.every(p => p.ready) || roomData.players.length < MIN_PLAYERS;
      } 
      // æ¸¸æˆé˜¶æ®µæŒ‰é’®
      else {
        $('betInputBox').style.display = 'flex';
        $('lookBtn').style.display = 'block';
        $('callBtn').style.display = 'block';
        $('raiseBtn').style.display = 'block';
        $('compareBtn').style.display = 'block';
        $('foldBtn').style.display = 'block';
        $('readyBtn').style.display = 'none';
        $('startBtn').style.display = 'none';

        $('lookBtn').disabled = !isMyTurn || myData.looked;
        $('callBtn').disabled = !isMyTurn || !canCall;
        $('raiseBtn').disabled = !isMyTurn || !canRaise;
        $('compareBtn').disabled = !isMyTurn || !canCompare;
        $('foldBtn').disabled = !isMyTurn;
        $('callBtn').innerText = canCall ? `è·Ÿæ³¨ ${callAmount}` : 'è·Ÿæ³¨';
      }
    }

    // æˆ¿ä¸»è®¾ç½®ç­¹ç æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    $('confirmSetChipBtn').onclick = () => {
      const selectedPlayerId = $('playerSelect').value;
      const chipNum = parseInt($('setChipInput').value);
      
      if (!selectedPlayerId) {
        alert('è¯·é€‰æ‹©è¦è®¾ç½®çš„ç©å®¶');
        return;
      }
      if (isNaN(chipNum) || chipNum < 0) {
        alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç­¹ç æ•°ï¼ˆâ‰¥0ï¼‰');
        return;
      }

      // æ›´æ–°ç©å®¶ç­¹ç 
      updateRoomData(room => {
        const player = room.players.find(p => p.id === selectedPlayerId);
        if (player) {
          player.chips = chipNum;
        }
      });
      alert('ç­¹ç è®¾ç½®æˆåŠŸï¼');
    };

    // åˆ›å»ºæˆ¿é—´
    $('createRoomBtn').onclick = () => {
      const nickname = $('nicknameInput').value.trim();
      if (!nickname) {
        alert('è¯·è¾“å…¥ä½ çš„æ˜µç§°');
        return;
      }
      myNickname = nickname;
      const roomId = generateRoomId();
      currentRoomId = roomId;

      const initRoom = {
        roomId,
        ownerId: myId,
        players: [
          {
            id: myId,
            nickname,
            isOwner: true,
            chips: 1000,
            ready: false,
            folded: false,
            looked: false,
            bet: 0,
            cards: []
          }
        ],
        gameStatus: 'waiting',
        pot: 0,
        currentMaxBet: 0,
        currentTurn: '',
        deck: []
      };
      RoomStore.set(roomId, initRoom);
      roomData = initRoom;

      showPage('gamePage');
      startSync();
      renderGamePage();
    };

    // åŠ å…¥æˆ¿é—´
    $('joinRoomBtn').onclick = () => {
      const nickname = $('nicknameInput').value.trim();
      const roomId = $('roomIdInput').value.trim();
      if (!nickname) {
        alert('è¯·è¾“å…¥ä½ çš„æ˜µç§°');
        return;
      }
      if (!roomId || roomId.length !== 6 || isNaN(roomId)) {
        alert('è¯·è¾“å…¥æ­£ç¡®çš„6ä½æ•°å­—æˆ¿é—´å·');
        return;
      }
      const room = RoomStore.get(roomId);
      if (!room) {
        alert('æˆ¿é—´ä¸å­˜åœ¨');
        return;
      }
      if (room.gameStatus !== 'waiting') {
        alert('æ¸¸æˆå·²å¼€å§‹ï¼Œè¯·ç­‰å¾…æœ¬å±€ç»“æŸ');
        return;
      }
      if (room.players.length >= MAX_PLAYERS) {
        alert('æˆ¿é—´äººæ•°å·²æ»¡');
        return;
      }

      myNickname = nickname;
      currentRoomId = roomId;

      updateRoomData(room => {
        room.players.push({
          id: myId,
          nickname,
          isOwner: false,
          chips: 1000,
          ready: false,
          folded: false,
          looked: false,
          bet: 0,
          cards: []
        });
      });

      showPage('gamePage');
      startSync();
      renderGamePage();
    };

    // å‡†å¤‡æŒ‰é’®
    $('readyBtn').onclick = () => {
      updateRoomData(room => {
        const player = room.players.find(p => p.id === myId);
        player.ready = !player.ready;
      });
    };

    // å¼€å§‹æ¸¸æˆ
    $('startBtn').onclick = () => {
      const deck = createDeck();
      updateRoomData(room => {
        room.gameStatus = 'playing';
        room.deck = deck;
        room.pot = 0;
        room.currentMaxBet = BASE_BET;
        room.currentTurn = room.players[0].id;

        room.players.forEach(player => {
          player.chips -= BASE_BET;
          player.bet = BASE_BET;
          room.pot += BASE_BET;
          player.cards = [room.deck.pop(), room.deck.pop(), room.deck.pop()];
          player.folded = false;
          player.looked = false;
        });
      });
    };

    // çœ‹ç‰Œ
    $('lookBtn').onclick = () => {
      updateRoomData(room => {
        const player = room.players.find(p => p.id === myId);
        player.looked = true;
      });
    };

    // è·Ÿæ³¨
    $('callBtn').onclick = () => {
      const myData = roomData.players.find(p => p.id === myId);
      const betDiff = roomData.currentMaxBet - myData.bet;
      const callAmount = myData.looked ? betDiff * 2 : betDiff;

      updateRoomData(room => {
        const player = room.players.find(p => p.id === myId);
        player.chips -= callAmount;
        player.bet += callAmount;
        room.pot += callAmount;

        // åˆ‡æ¢è½®æ¬¡
        const activePlayers = room.players.filter(p => !p.folded);
        const currentIndex = activePlayers.findIndex(p => p.id === room.currentTurn);
        const nextIndex = (currentIndex + 1) % activePlayers.length;
        room.currentTurn = activePlayers[nextIndex].id;
      });
    };

    // åŠ æ³¨
    $('raiseBtn').onclick = () => {
      const raiseAmount = parseInt($('betInput').value);
      const myData = roomData.players.find(p => p.id === myId);
      const betDiff = roomData.currentMaxBet - myData.bet;
      const baseCost = myData.looked ? betDiff * 2 : betDiff;
      const raiseCost = myData.looked ? raiseAmount * 2 : raiseAmount;
      const totalCost = baseCost + raiseCost;

      if (isNaN(raiseAmount) || raiseAmount < BASE_BET || totalCost > myData.chips) {
        alert(`åŠ æ³¨é‡‘é¢æ— æ•ˆï¼Œéœ€â‰¥${BASE_BET}`);
        return;
      }

      updateRoomData(room => {
        const player = room.players.find(p => p.id === myId);
        player.chips -= totalCost;
        player.bet += totalCost;
        room.pot += totalCost;
        room.currentMaxBet += raiseAmount;

        // åˆ‡æ¢è½®æ¬¡
        const activePlayers = room.players.filter(p => !p.folded);
        const currentIndex = activePlayers.findIndex(p => p.id === room.currentTurn);
        const nextIndex = (currentIndex + 1) % activePlayers.length;
        room.currentTurn = activePlayers[nextIndex].id;
      });
    };

    // æ¯”ç‰Œ
    $('compareBtn').onclick = () => {
      const activePlayers = roomData.players.filter(p => !p.folded);
      if (activePlayers.length < 2) return;

      const currentIndex = activePlayers.findIndex(p => p.id === myId);
      const targetIndex = currentIndex === 0 ? activePlayers.length - 1 : currentIndex - 1;
      const targetPlayer = activePlayers[targetIndex];
      const myData = roomData.players.find(p => p.id === myId);

      const myHand = evaluateHand(myData.cards);
      const targetHand = evaluateHand(targetPlayer.cards);
      const winner = compareHands(myHand, targetHand, true);

      updateRoomData(room => {
        if (winner === 'hand1') {
          const loser = room.players.find(p => p.id === targetPlayer.id);
          loser.folded = true;
        } else {
          const loser = room.players.find(p => p.id === myId);
          loser.folded = true;
        }

        // æ£€æŸ¥æ˜¯å¦åªå‰©1äºº
        const remainingPlayers = room.players.filter(p => !p.folded);
        if (remainingPlayers.length === 1) {
          const finalWinner = remainingPlayers[0];
          finalWinner.chips += room.pot;
          room.gameStatus = 'roundEnd';
          renderResultModal(finalWinner, room.players);
        } else {
          // åˆ‡æ¢è½®æ¬¡
          const activePlayers = room.players.filter(p => !p.folded);
          const currentIndex = activePlayers.findIndex(p => p.id === room.currentTurn);
          const nextIndex = (currentIndex + 1) % activePlayers.length;
          room.currentTurn = activePlayers[nextIndex].id;
        }
      });
    };

    // å¼ƒç‰Œ
    $('foldBtn').onclick = () => {
      updateRoomData(room => {
        const player = room.players.find(p => p.id === myId);
        player.folded = true;

        const remainingPlayers = room.players.filter(p => !p.folded);
        if (remainingPlayers.length === 1) {
          const finalWinner = remainingPlayers[0];
          finalWinner.chips += room.pot;
          room.gameStatus = 'roundEnd';
          renderResultModal(finalWinner, room.players);
        } else {
          // åˆ‡æ¢è½®æ¬¡
          const activePlayers = room.players.filter(p => !p.folded);
          const currentIndex = activePlayers.findIndex(p => p.id === room.currentTurn);
          const nextIndex = (currentIndex + 1) % activePlayers.length;
          room.currentTurn = activePlayers[nextIndex].id;
        }
      });
    };

    // æ¸²æŸ“ç»“æœå¼¹çª—
    function renderResultModal(winner, allPlayers) {
      $('resultTitle').innerText = `${winner.nickname} è·èƒœï¼`;
      
      let cardsHtml = '';
      allPlayers.forEach(player => {
        const hand = evaluateHand(player.cards);
        cardsHtml += `
          <div class="result-player-cards">
            <div>${player.nickname}ï¼ˆ${HAND_TYPE_NAME[hand.type]}ï¼‰</div>
            <div class="result-card-row">
              ${player.cards.map(c => `<div class="card ${c.color}">${c.rank}${c.suit}</div>`).join('')}
            </div>
          </div>
        `;
      });
      $('resultCards').innerHTML = cardsHtml;
      $('resultDesc').innerText = `èµ¢èµ°å¥–æ±  ${roomData.pot} ç­¹ç `;
      $('resultModal').classList.add('active');
    }

    // å…³é—­ç»“æœå¼¹çª—
    $('closeResultBtn').onclick = () => {
      $('resultModal').classList.remove('active');
      updateRoomData(room => {
        room.gameStatus = 'waiting';
        room.pot = 0;
        room.currentMaxBet = 0;
        room.currentTurn = '';
        room.players.forEach(player => {
          player.ready = false;
          player.bet = 0;
          player.cards = [];
          player.folded = false;
          player.looked = false;
        });
      });
    };

    // é€€å‡ºæˆ¿é—´
    function exitRoom() {
      stopSync();
      if (currentRoomId) {
        const room = RoomStore.get(currentRoomId);
        if (room) {
          room.players = room.players.filter(p => p.id !== myId);
          if (room.players.length === 0) {
            RoomStore.delete(currentRoomId);
          } else {
            if (room.ownerId === myId) {
              room.ownerId = room.players[0].id;
              room.players[0].isOwner = true;
            }
            RoomStore.set(currentRoomId, room);
          }
        }
      }
      currentRoomId = '';
      roomData = {};
      showPage('homePage');
    }
    $('exitRoomBtn').onclick = exitRoom;
    window.onbeforeunload = exitRoom;
  </script>
</body>
</html>
